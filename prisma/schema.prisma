// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// MULTI-TENANCY: SCHOOL (TENANT)
// ============================================

model School {
  id           String   @id @default(cuid())
  nama         String   // Nama sekolah
  npsn         String?  @unique // Nomor Pokok Sekolah Nasional
  alamat       String?
  kota         String?
  provinsi     String?
  noTelp       String?
  email        String?  @unique
  website      String?
  logo         String?  // URL to logo
  jenjang      String?  // SD, SMP, SMA, SMK
  isActive     Boolean  @default(true)
  tierId       String?  // FK to Tier
  expiredAt    DateTime? // Tanggal expired subscription
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  tier           Tier?    @relation(fields: [tierId], references: [id])
  users          User[]
  sekolahInfo    SekolahInfo[]
  kelas          Kelas[]
  mataPelajaran  MataPelajaran[]
  guru           Guru[]
  siswa          Siswa[]
  jadwal         Jadwal[]
  infoMasuk      InfoMasuk[]
  ujian          Ujian[]
  tugas          Tugas[]
  materi         Materi[]
  ujianAccessControl UjianAccessControl[]

  @@index([nama])
  @@index([isActive])
  @@index([npsn])
  @@index([tierId])
  @@map("schools")
}

// ============================================
// SUPERADMIN (Platform-level)
// ============================================

model SuperAdmin {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  nama      String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@map("super_admins")
}

// ============================================
// TIER / SUBSCRIPTION PLANS
// ============================================

model Tier {
  id          String   @id @default(cuid())
  nama        String   @unique // trial, starter, basic, professional, enterprise
  label       String   // Display name: "Trial", "Starter", etc.
  harga       Int      @default(0) // Harga per bulan (IDR)
  maxSiswa    Int      @default(50)
  maxGuru     Int      @default(5)
  maxKelas    Int      @default(5)
  maxMapel    Int      @default(10)
  maxUjian    Int      @default(10) // Per bulan
  maxStorage  Int      @default(500) // MB
  fipitur     Json?    // Feature flags: { aiChatbot: true, exportPdf: true, ... }
  isActive    Boolean  @default(true)
  urutan      Int      @default(0) // Sort order
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  schools     School[]

  @@index([nama])
  @@index([urutan])
  @@map("tiers")
}

// ============================================
// SMTP CONFIGURATION (Platform-level)
// ============================================

model SmtpConfig {
  id          String   @id @default(cuid())
  host        String   // smtp.gmail.com
  port        Int      @default(587)
  secure      Boolean  @default(false) // true for 465, false for 587
  user        String   // email@domain.com
  pass        String   // app password (encrypted)
  fromName    String   @default("E-Learning Platform")
  fromEmail   String   // noreply@platform.com
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("smtp_config")
}

// ============================================
// PLATFORM NOTIFICATIONS (Push to tenants)
// ============================================

model PlatformNotification {
  id          String   @id @default(cuid())
  judul       String
  pesan       String   @db.Text
  tipe        String   // info, warning, update, maintenance, promo
  targetRole  String[] // ["ADMIN", "GURU", "SISWA"] or ["ALL"]
  targetSchoolIds String[] // Empty = all schools
  priority    String   @default("normal") // low, normal, high, urgent
  isPublished Boolean  @default(false)
  publishedAt DateTime?
  expiresAt   DateTime?
  createdBy   String   // SuperAdmin ID
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  reads       NotificationRead[]

  @@index([isPublished])
  @@index([tipe])
  @@index([publishedAt])
  @@map("platform_notifications")
}

model NotificationRead {
  id              String   @id @default(cuid())
  notificationId  String
  userId          String   // User who read it
  readAt          DateTime @default(now())

  // Relations
  notification PlatformNotification @relation(fields: [notificationId], references: [id], onDelete: Cascade)

  @@unique([notificationId, userId])
  @@index([userId])
  @@map("notification_reads")
}

// ============================================
// BROADCAST EMAIL
// ============================================

model BroadcastEmail {
  id            String   @id @default(cuid())
  subject       String
  body          String   @db.Text // HTML content
  targetType    String   // all_schools, specific_schools, by_tier
  targetFilter  Json?    // { schoolIds: [...], tierIds: [...] }
  status        String   @default("draft") // draft, sending, sent, failed
  sentCount     Int      @default(0)
  failedCount   Int      @default(0)
  sentAt        DateTime?
  createdBy     String   // SuperAdmin ID
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([status])
  @@index([createdAt])
  @@map("broadcast_emails")
}

// ============================================
// PASSWORD RESET TOKENS
// ============================================

model PasswordResetToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([email])
  @@index([token])
  @@index([expiresAt])
  @@map("password_reset_tokens")
}

// ============================================
// USER & AUTHENTICATION
// ============================================

model User {
  id           String   @id @default(cuid())
  schoolId     String
  email        String   @unique
  password     String
  role         UserRole
  profilePhoto String?  // URL to profile photo
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  school School @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  siswa  Siswa?
  guru   Guru?

  @@index([schoolId, createdAt])
  @@index([email])
  @@index([role])
  @@index([isActive])
  @@map("users")
}

enum UserRole {
  ADMIN
  GURU
  SISWA
}

// ============================================
// SCHOOL INFORMATION
// ============================================

model SekolahInfo {
  id        String   @id @default(cuid())
  schoolId  String
  
  // Informasi Sekolah
  namaSekolah    String
  alamat         String
  noTelp         String
  email          String
  website        String?
  logo           String?  // URL to logo file
  
  // Kepala Sekolah
  namaKepsek     String
  nipKepsek      String
  
  // Tahun Ajaran
  tahunAjaran    String   // 2024/2025
  semester       String   // Ganjil/Genap
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  school School @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  @@index([schoolId])
  @@map("sekolah_info")
}

// ============================================
// MASTER DATA
// ============================================

model Kelas {
  id          String   @id @default(cuid())
  schoolId    String
  nama        String // 7A, 7B, 8A, etc
  tingkat     String // 7, 8, 9
  waliKelasId String?
  tahunAjaran String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  school    School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  waliKelas Guru?    @relation("WaliKelas", fields: [waliKelasId], references: [id])
  siswa     Siswa[]
  guru      GuruKelas[]
  jadwal    Jadwal[]

  @@unique([schoolId, nama])
  @@index([schoolId])
  @@index([nama])
  @@index([tingkat])
  @@index([tahunAjaran])
  @@map("kelas")
}

model MataPelajaran {
  id        String   @id @default(cuid())
  schoolId  String
  nama      String
  kode      String
  jenis     String // wajib, peminatan
  jamPerMinggu Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  school  School     @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  guru    GuruMapel[]
  jadwal  Jadwal[]
  materi  Materi[]
  ujian   Ujian[]
  tugas   Tugas[]

  @@unique([schoolId, nama])
  @@unique([schoolId, kode])
  @@index([schoolId])
  @@map("mata_pelajaran")
}

// ============================================
// GURU
// ============================================

model Guru {
  id           String   @id @default(cuid())
  schoolId     String
  userId       String   @unique
  nipUsername  String // NIP atau Username
  nama         String
  email        String   @unique
  alamat       String?
  jenisKelamin String
  foto         String?  // URL to profile photo
  isActive     Boolean  @default(true) // Status aktif guru
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  school        School          @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  mapel         GuruMapel[]     // Guru bisa mengajar banyak mapel
  kelas         GuruKelas[]     // Guru bisa mengajar di banyak kelas
  waliKelas     Kelas[]         @relation("WaliKelas")
  jadwal        Jadwal[]
  materi        Materi[]
  ujian         Ujian[]
  tugas         Tugas[]
  gradeConfig   GradeConfig?    // Konfigurasi bobot penilaian

  @@unique([schoolId, nipUsername])
  @@index([schoolId, createdAt])
  @@index([nipUsername])
  @@index([email])
  @@index([userId])
  @@map("guru")
}

model GuruMapel {
  id      String @id @default(cuid())
  guruId  String
  mapelId String

  guru  Guru          @relation(fields: [guruId], references: [id], onDelete: Cascade)
  mapel MataPelajaran @relation(fields: [mapelId], references: [id], onDelete: Cascade)

  @@unique([guruId, mapelId])
  @@map("guru_mapel")
}

model GuruKelas {
  id      String @id @default(cuid())
  guruId  String
  kelasId String

  guru  Guru  @relation(fields: [guruId], references: [id], onDelete: Cascade)
  kelas Kelas @relation(fields: [kelasId], references: [id], onDelete: Cascade)

  @@unique([guruId, kelasId])
  @@map("guru_kelas")
}

// ============================================
// SISWA
// ============================================

model Siswa {
  id           String   @id @default(cuid())
  schoolId     String
  userId       String   @unique
  nisn         String
  nis          String
  nama         String
  email        String?  @unique
  kelasId      String
  jenisKelamin String
  tanggalLahir DateTime?
  alamat       String?
  noTelp       String?
  namaWali     String?
  noTelpWali   String?
  foto         String?  // URL to profile photo
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  school            School              @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  kelas             Kelas               @relation(fields: [kelasId], references: [id])
  presensi          Presensi[]
  kartuPelajar      KartuPelajar?
  tugasSubmission   TugasSubmission[]
  ujianSubmission   UjianSubmission[]

  @@unique([schoolId, nisn])
  @@unique([schoolId, nis])
  @@index([schoolId, createdAt])
  @@index([nisn])
  @@index([nis])
  @@index([kelasId])
  @@index([email])
  @@index([userId])
  @@map("siswa")
}

// ============================================
// KARTU PELAJAR
// ============================================

model KartuPelajar {
  id                String   @id @default(cuid())
  siswaId           String   @unique
  tanggalTerbit     DateTime @default(now())
  tanggalKadaluarsa DateTime
  status            String   @default("aktif") // aktif, nonaktif, hilang
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  siswa Siswa @relation(fields: [siswaId], references: [id], onDelete: Cascade)

  @@map("kartu_pelajar")
}

// ============================================
// JADWAL
// ============================================

model Jadwal {
  id         String   @id @default(cuid())
  schoolId   String
  kelasId    String
  mapelId    String
  guruId     String
  hari       String // Senin, Selasa, etc
  jamMulai   String // 08:00
  jamSelesai String // 09:30
  ruangan    String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  school School        @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  kelas  Kelas         @relation(fields: [kelasId], references: [id], onDelete: Cascade)
  mapel  MataPelajaran @relation(fields: [mapelId], references: [id], onDelete: Cascade)
  guru   Guru          @relation(fields: [guruId], references: [id], onDelete: Cascade)

  @@index([schoolId])
  @@map("jadwal")
}

// ============================================
// INFO MASUK & PULANG
// ============================================

model InfoMasuk {
  id        String   @id @default(cuid())
  schoolId  String
  hari      String   // Senin, Selasa, Rabu, Kamis, Jumat, Sabtu, Minggu
  jamMasuk  String   // 07:00
  jamPulang String   // 14:00
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  school School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@unique([schoolId, hari])
  @@index([schoolId])
  @@index([hari])
  @@map("info_masuk")
}

// ============================================
// PRESENSI
// ============================================

model Presensi {
  id         String   @id @default(cuid())
  siswaId    String
  tanggal    DateTime @default(now())
  status     String // hadir, izin, sakit, alpha
  keterangan String?
  tipe       String   @default("masuk") // masuk, pulang
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  siswa Siswa @relation(fields: [siswaId], references: [id], onDelete: Cascade)

  @@unique([siswaId, tanggal, tipe])
  @@index([siswaId])
  @@index([tanggal])
  @@index([status])
  @@index([tipe])
  @@map("presensi")
}

// ============================================
// MATERI PEMBELAJARAN
// ============================================

model Materi {
  id            String   @id @default(cuid())
  schoolId      String
  judul         String
  deskripsi     String?
  mapelId       String
  guruId        String
  kelas         String[] // Array of kelas names
  tipe          String // pdf, video, image, link
  fileUrl       String?
  ukuran        String?
  tanggalUpload DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  school School        @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  mapel  MataPelajaran @relation(fields: [mapelId], references: [id], onDelete: Cascade)
  guru   Guru          @relation(fields: [guruId], references: [id], onDelete: Cascade)

  @@index([schoolId])
  @@map("materi")
}

// ============================================
// TUGAS
// ============================================

model Tugas {
  id          String   @id @default(cuid())
  schoolId    String
  judul       String
  deskripsi   String
  instruksi   String
  mapelId     String
  guruId      String
  kelas       String[] // Array of kelas names
  deadline    DateTime
  fileUrl     String?
  status      String   @default("aktif") // aktif, selesai
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  school      School            @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  mapel       MataPelajaran     @relation(fields: [mapelId], references: [id], onDelete: Cascade)
  guru        Guru              @relation(fields: [guruId], references: [id], onDelete: Cascade)
  submissions TugasSubmission[]

  @@index([schoolId, createdAt])
  @@index([guruId])
  @@index([mapelId])
  @@index([status])
  @@index([deadline])
  @@map("tugas")
}

model TugasSubmission {
  id          String    @id @default(cuid())
  tugasId     String
  siswaId     String
  fileUrl     String?   // URL link (Google Drive, etc) - nullable
  fileUpload  String?   // Uploaded file path - nullable
  catatan     String?
  nilai       Int?
  feedback    String?
  submittedAt DateTime  @default(now())
  gradedAt    DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  tugas Tugas @relation(fields: [tugasId], references: [id], onDelete: Cascade)
  siswa Siswa @relation(fields: [siswaId], references: [id], onDelete: Cascade)

  @@unique([tugasId, siswaId])
  @@index([tugasId])
  @@index([siswaId])
  @@index([submittedAt])
  @@map("tugas_submission")
}

// ============================================
// UJIAN
// ============================================

model Ujian {
  id                String   @id @default(cuid())
  schoolId          String
  judul             String
  deskripsi         String?
  mapelId           String
  guruId            String
  kelas             String[] // Array of kelas names
  startUjian        DateTime // Waktu mulai ujian (tanggal + jam)
  endUjian          DateTime // Waktu akhir ujian (tanggal + jam)
  shuffleQuestions  Boolean  @default(false)
  showScore         Boolean  @default(true)
  status            String   @default("draft") // draft, aktif, selesai
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  school           School             @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  mapel            MataPelajaran      @relation(fields: [mapelId], references: [id], onDelete: Cascade)
  guru             Guru               @relation(fields: [guruId], references: [id], onDelete: Cascade)
  soal             Soal[]
  submissions      UjianSubmission[]

  @@index([schoolId, createdAt])
  @@index([guruId])
  @@index([mapelId])
  @@index([status])
  @@index([startUjian])
  @@index([endUjian])
  @@map("ujian")
}

// ============================================
// UJIAN ACCESS CONTROL (Admin Only - Global)
// ============================================

model UjianAccessControl {
  id              String    @id @default(cuid())
  schoolId        String
  isActive        Boolean   @default(false) // Global exam access status
  currentToken    String?   // Current active token (6-digit code)
  tokenGeneratedAt DateTime? // When token was generated
  tokenExpiresAt  DateTime? // Token expires after 2 minutes
  generatedBy     String?   // Admin user ID who generated token
  description     String?   // Optional description for this session
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  school School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@index([schoolId])
  @@map("ujian_access_control")
}



// ============================================
// SOAL BARU (Multi-Type Unified System)
// ============================================

model Soal {
  id            String   @id @default(cuid())
  ujianId       String
  tipe          String   // 'PILIHAN_GANDA', 'ESSAY', 'ISIAN_SINGKAT', 'PENCOCOKAN', 'BENAR_SALAH'
  urutan        Int      // Urutan global untuk semua tipe soal
  pertanyaan    String   @db.Text // Support rich text panjang
  poin          Int      @default(1) // Bobot poin per soal
  
  // Data spesifik per tipe soal (JSON flexible)
  data          Json     // PostgreSQL JSONB
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  ujian         Ujian              @relation(fields: [ujianId], references: [id], onDelete: Cascade)
  jawaban       JawabanSoal[]

  @@index([ujianId, urutan])
  @@index([tipe])
  @@map("soal")
}

model JawabanSoal {
  id            String   @id @default(cuid())
  submissionId  String
  soalId        String
  
  // Jawaban siswa (format sesuai tipe soal)
  jawaban       Json     // PostgreSQL JSONB
  
  nilai         Int?     // Nilai untuk soal ini
  feedback      String?  @db.Text // Feedback dari guru
  isCorrect     Boolean? // Auto-graded untuk PG, Isian, Benar-Salah
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  submission    UjianSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  soal          Soal            @relation(fields: [soalId], references: [id], onDelete: Cascade)

  @@unique([submissionId, soalId])
  @@index([submissionId])
  @@index([soalId])
  @@map("jawaban_soal")
}

model UjianSubmission {
  id          String    @id @default(cuid())
  ujianId     String
  siswaId     String
  startedAt   DateTime  @default(now())
  submittedAt DateTime?
  nilai       Int?
  status      String    @default("in_progress") // in_progress, submitted, graded
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  ujian              Ujian                   @relation(fields: [ujianId], references: [id], onDelete: Cascade)
  siswa              Siswa                   @relation(fields: [siswaId], references: [id], onDelete: Cascade)
  jawabanSoal        JawabanSoal[]

  @@unique([ujianId, siswaId])
  @@index([ujianId])
  @@index([siswaId])
  @@index([status])
  @@map("ujian_submission")
}

// ============================================
// GRADE CONFIGURATION
// ============================================

model GradeConfig {
  id              String   @id @default(cuid())
  guruId          String   @unique // Satu guru satu konfigurasi
  namaPG          String   @default("Pilihan Ganda") // Nama komponen PG
  bobotPG         Int      @default(50) // Persentase bobot PG (0-100)
  activePG        Boolean  @default(true) // Apakah komponen PG aktif
  namaEssay       String   @default("Essay") // Nama komponen Essay
  bobotEssay      Int      @default(50) // Persentase bobot Essay (0-100)
  activeEssay     Boolean  @default(true) // Apakah komponen Essay aktif
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  guru Guru @relation(fields: [guruId], references: [id], onDelete: Cascade)

  @@index([guruId])
  @@map("grade_config")
}

// ============================================
// FAILED NOTIFICATIONS
// ============================================

model FailedNotification {
  id        String   @id @default(cuid())
  receiver  String   // Nomor WhatsApp
  message   String   @db.Text // Pesan yang gagal dikirim
  error     String?  // Error message
  failedAt  DateTime @default(now())
  retried   Boolean  @default(false) // Apakah sudah dicoba ulang manual
  retriedAt DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([receiver])
  @@index([failedAt])
  @@index([retried])
  @@map("failed_notifications")
}

// ============================================
// LANDING PAGE MEDIA
// ============================================

model LandingMedia {
  id          String   @id @default(cuid())
  tipe        String   // "image" | "video"
  judul       String   // Judul/caption
  url         String   // Image path or YouTube URL
  aspectRatio String   @default("16:9") // "16:9" | "9:16" | "1:1"
  urutan      Int      @default(0) // Urutan tampil
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([tipe])
  @@index([isActive])
  @@index([urutan])
  @@map("landing_media")
}

// ============================================
// NILAI - REMOVED
// ============================================
// Nilai sekarang dihitung langsung dari UjianSubmission
// menggunakan persentase bobot PG & Essay dari GradeConfig
// Tidak perlu tabel terpisah karena nilai = rata-rata semua ujian
